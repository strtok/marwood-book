[heap]: https://github.com/strtok/marwood/blob/master/marwood/src/vm/heap.rs
[environment]: https://github.com/strtok/marwood/blob/master/marwood/src/vm/environment.rs
[stack]: https://github.com/strtok/marwood/blob/master/marwood/src/vm/stack.rs
[virtual machine]: https://github.com/strtok/marwood/blob/master/marwood/src/vm/mod.rs

# Virtual Machine

The `Vm` object is used to construct and evaluate expressions on Marwood's stack based [Virtual Machine]. Each `Vm` object maintains its own global state, heap, and runtime stack:

```rust,noplayground
#[derive(Debug)]
pub struct Vm {
    /// The heap and global environment
    heap: Heap,
    globenv: GlobalEnvironment,

    /// The current program stack
    stack: Stack,

    /// Registers
    acc: VCell,
    ep: usize,
    ip: (usize, usize),
    bp: usize,

    /// System Interface (display, write, etc).
    sys: Box<dyn SystemInterface>,
}
```

The `Vm` object provides an eval interface for evaluating scheme expressions, and is the main interface for the console and web repl:

```rust,noplayground
fn eval(&mut self, cell: &Cell) -> Result<Cell, Error>
```

## Components

The `Vm` is composed of these high-level components:

* a [stack]
* a garbage collected [heap]
* the global [environment]
* registers

## Registers

Marwood's Vm has a handful of registers that are used to maintain currently running program state:

| Register | Description         |
|----------|---------------------|
| %acc     | Accumulator         |
| %ip      | Instruction Pointer |
| %bp      | Frame Base Pointer  |
| %sp      | Stack Pointer       |
| %ep      | Environment Pointer |

The %acc register is used to store the result of a number of Marwood's Vm instructions, and is also used to store the result of procedure application.

The %ip register points to the currently running byte code.

The %bp, %sp and %ep registers maintain state of Marwood's stack and call frame state.

## OpCodes

| Opcode                       | Description                                                                                                           |
|------------------------------|-----------------------------------------------------------------------------------------------------------------------|
| CALL %acc                    | Given the arguments for the procedure in %acc have been pushed on the stack, jump to the procedure in %acc.           |
| CLOSURE %acc                 | Create a lexical environment as a result of evaluating a (lambda ...) expression.                                     |
| ENVGET &lt;SLOT&gt;          | Store the value in environment slot SLOT in ACC                                                                       |
| ENVSET &lt;SLOT&gt;          | Set the value in environment slot SLOT to the value in ACC                                                            |
| ENTER                        | Setup the currently executing procedure's stack frame                                                                 |
| HALT                         | Halt program, returning the result contained within ACC                                                               |
| JNT &lt;OFFSET&gt;           | Set %ip to OFFSET if %acc is #f                                                                                       |
| JMP &lt;OFFSET&gt;           | Set %ip to OFFSET                                                                                                     |
| MOV &lt;SRC&gt; &lt;DEST&gt; | Move the value from SRC into DEST                                                                                     |
| PUSH                         | Push the value in ACC on to the stack                                                                                 |
| RET                          | Return from a procedure entered via CALL                                                                              |
| TCALL %acc                   | Identical to a CALL instruction, except that a tail optimizing CALL is performed.                                     |

